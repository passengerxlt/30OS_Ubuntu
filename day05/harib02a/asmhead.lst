     1                                  ; haribote-os boot asm
     2                                  ; TAB=4
     3                                  
     4                                  BOTPAK	EQU	0x00280000
     5                                  DSKCAC	EQU	0x00100000
     6                                  DSKCAC0	EQU	0x00008000
     7                                  
     8                                  CYLS	EQU	0x0ff0
     9                                  LEDS	EQU	0x0ff1
    10                                  VMODE	EQU	0x0ff2
    11                                  SCRNX	EQU	0x0ff4
    12                                  SCRNY	EQU	0x0ff6
    13                                  VRAM	EQU	0x0ff8
    14                                  
    15                                  	ORG	0xc400
    16                                  
    17                                  ;
    18 00000000 B013                    	MOV	AL, 0x13
    19 00000002 B400                    	MOV	AH, 0x00
    20 00000004 CD10                    	INT	0x10		; 设置VGA显卡，320x200x8位彩色
    21 00000006 C606F20F08              	MOV	BYTE [VMODE], 8
    22 0000000B C706F40F4001            	MOV	WORD [SCRNX], 320
    23 00000011 C706F60FC800            	MOV	WORD [SCRNY], 200
    24 00000017 66C706F80F00000A00      	MOV	DWORD [VRAM], 0x000a0000
    25                                  
    26                                  ;
    27 00000020 B402                    	MOV	AH, 0x02
    28 00000022 CD16                    	INT	0x16
    29 00000024 A2F10F                  	MOV	[LEDS], AL
    30                                  
    31                                  ;
    32 00000027 B0FF                    	MOV	AL, 0xff
    33 00000029 E621                    	OUT	0x21, AL
    34 0000002B 90                      	NOP
    35                                  
    36 0000002C E6A1                    	OUT	0xa1, AL	;写两个端口，初始化关闭PIC，也算关了NMIs。
    37                                  
    38 0000002E FA                      	CLI
    39                                  
    40 0000002F E88B00                  	CALL	waitkbdout
    41 00000032 B0D1                    	MOV	AL, 0xd1
    42 00000034 E664                    	OUT	0x64, AL
    43 00000036 E88400                  	CALL	waitkbdout
    44 00000039 B0DF                    	MOV	AL, 0xdf
    45 0000003B E660                    	OUT	0x60, AL
    46 0000003D E87D00                  	CALL	waitkbdout	; 键盘控制器的附属端口，用于打开A20地址线
    47                                  
    48                                  ;[INSTRSET "i486p"]，虽然是16位指令，但可以使用32位寄存器之类的。
    49 00000040 0F0116[F500]            	LGDT 	[GDTR0]
    50 00000045 0F20C0                  	MOV	EAX, CR0
    51 00000048 6625FFFFFF7F            	AND	EAX, 0x7fffffff
    52 0000004E 6683C801                	OR	EAX, 0x00000001
    53 00000052 0F22C0                  	MOV	CR0, EAX	; 进入保护模式，保护模式的特性只是在相应的地方起作用，如跳转时的检测，分页的检测等，此时由于没有改变CS的值，CPU使用的基地址没有改变（基
    54 00000055 EB00                    	JMP	pipelineflush 	
    55                                  pipelineflush:
    56 00000057 B80800                  	MOV	AX, 1*8		; 段选择子，16位。高13位代表序号，然后TI，RPL
    57 0000005A 8ED8                    	MOV	DS, AX
    58 0000005C 8EC0                    	MOV	ES, AX
    59 0000005E 8EE0                    	MOV	FS, AX
    60 00000060 8EE8                    	MOV	GS, AX
    61 00000062 8ED0                    	MOV	SS, AX		; 数据段，堆栈段等使用同一个段。已进入保护模式，加载段寄存器时，可见部分和不可见部分都会修改。
    62                                  
    63                                  ; 32位代码拷贝到BOTPAK=0x00280000处
    64 00000064 66BE[FB000000]          	MOV	ESI, bootpack
    65 0000006A 66BF00002800            	MOV	EDI, BOTPAK
    66 00000070 66B900000200            	MOV	ECX, 512 * 1024/4
    67 00000076 E84B00                  	CALL	memcpy	; 短CALL，没有改变CS的值。
    68                                  
    69                                  ; 把0x7c00处即MBR或第一个扇区代码拷贝到DSKCAC=0x00100000处
    70 00000079 66BE007C0000            	MOV	ESI, 0x7c00
    71 0000007F 66BF00001000            	MOV	EDI, DSKCAC
    72 00000085 66B980000000            	MOV	ECX, 512/4
    73 0000008B E83600                  	CALL	memcpy
    74                                  
    75                                  ; 把从0x8200即第二个扇区开始处代码拷贝到DSKCAC+0x200处，共18＊2 - 1个扇区，所以前18个柱面现在在DSKCAC=0x00100000处。
    76 0000008E 66BE00820000            	MOV	ESI, DSKCAC0+512
    77 00000094 66BF00021000            	MOV	EDI, DSKCAC+512
    78 0000009A 66B900000000            	MOV	ECX, 0
    79 000000A0 8A0EF00F                	MOV	CL, BYTE[CYLS]
    80 000000A4 6669C900120000          	IMUL	ECX, 512*18*2/4
    81 000000AB 6681E980000000          	SUB	ECX,512/4
    82 000000B2 E80F00                  	CALL	memcpy
    83                                  
    84                                  ;	MOV	EBX, BOTPAK
    85                                  ;	MOV	ECX, [EBX+16]
    86                                  ;  	ADD	ECX, 3
    87                                  ;	SHR	ECX, 2
    88                                  ;	JZ	skip
    89                                  ;	MOV	ESI, [EBX+20]
    90                                  ;	ADD	ESI, EBX
    91                                  ;	MOV	EDI, [EBX+12]
    92                                  ;	CALL	memcpy		
    93                                  skip:
    94                                  ;	MOV	ESP, [EBX+12]	;
    95 000000B5 66EA800000001000        	JMP	DWORD 2*8:0x00000080 ; 改变CS的值，基地址也随之改变，剥离出文件格式信息时失败，还是使用入口偏移，此ELF功能简单，偏移几乎不变，也不需要映射段和重定位
    96                                  
    97                                  waitkbdout:
    98 000000BD E464                    	IN	AL, 0x64
    99 000000BF 2402                    	AND	AL, 0x02
   100 000000C1 75FA                    	JNZ	waitkbdout
   101 000000C3 C3                      	RET
   102                                  
   103                                  memcpy:
   104 000000C4 66678B06                	MOV	EAX, [ESI]
   105 000000C8 6683C604                	ADD	ESI, 4
   106 000000CC 66678907                	MOV	[EDI], EAX
   107 000000D0 6683C704                	ADD	EDI, 4
   108 000000D4 6683E901                	SUB	ECX, 1
   109 000000D8 75EA                    	JNZ	memcpy
   110 000000DA C3                      	RET
   111                                  		
   112                                  GDT0:
   113 000000DB 00<rept>                	TIMES 8 DB 0
   114 000000E3 FFFF00000092CF00        	DW	0xffff, 0x0000, 0x9200, 0x00cf
   115 000000EB FFFF0000289A4700        	DW	0xffff, 0x0000, 0x9a28, 0x0047
   116                                  
   117 000000F3 0000                    	DW	0
   118                                  GDTR0:
   119 000000F5 1700                    	DW	8*3-1
   120 000000F7 [DB000000]              	DD	GDT0
   121                                  bootpack:	
