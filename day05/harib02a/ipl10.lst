     1                                  ; hello-os
     2                                  ; TAB=4
     3                                  
     4                                  	CYLS	EQU	10
     5                                  	
     6                                  	ORG	0x7c00	       		; 指明程序的装载地址
     7                                  	
     8                                  ; 以下的记述用于标准的FAT12格式的软盘
     9 00000000 EB4E                    	JMP	entry
    10 00000002 90                      	DB	0x90
    11                                  	
    12                                  ;  
    13 00000003 48454C4C4F49504C        	DB	"HELLOIPL"		; 启动去的名称可以是任意的字符串（8字节）
    14 0000000B 0002                    	DW	512			; 扇区大小（必须512）
    15 0000000D 01                      	DB	1			; 簇的大小（必须一个扇区）
    16 0000000E 0100                    	DW	1			; FAT的起始位置（一般从第一个扇区开始）
    17 00000010 02                      	DB	2			; FAT的个数（必须为2）
    18 00000011 E000                    	DW	224			; 根目录的大小（一般设成224项）
    19 00000013 400B                    	DW	2880			; 该磁盘的大小（必须2880扇区）
    20 00000015 F0                      	DB	0xf0			; 磁盘的种类（必须是0xf0）
    21 00000016 0900                    	DW	9			; FAT的长度（必须是9扇区）
    22 00000018 1200                    	DW	18			; 1个磁道有几个扇区（必须是18）
    23 0000001A 0200                    	DW	2			; 磁头数（必须是2）
    24 0000001C 00000000                	DD	0			; 不使用分区，必须是0
    25 00000020 400B0000                	DD	2880			; 重写一次磁盘大小
    26 00000024 000029                  	DB	0,0,0x29		; 意义不明，固定
    27 00000027 FFFFFF00                	DD	0xffffff		; （可能是）卷表号码
    28 0000002B 48454C4C4F2D4F5320-     	DB	"HELLO-OS   "		; 磁盘的名称（11字节）
    29 00000034 2020               
    30 00000036 4641543132202020        	DB	"FAT12   "		; 磁盘格式名称（8字节）
    31 0000003E 00<rept>                	times 18 DB 0			; 先空出18个字节
    32                                  
    33                                  ; 程序核心
    34                                  entry:	
    35 00000050 B80000                  	MOV	AX, 0			; 初始化寄存器
    36 00000053 8ED0                    	MOV	SS, AX
    37 00000055 BC007C                  	MOV	SP, 0x7c00		; 准备栈
    38 00000058 8ED8                    	MOV	DS, AX			; DS默认的地址段寄存器，所以需初始化
    39                                  
    40                                  ; 准备读取软盘A的2-18扇区
    41 0000005A B200                    	MOV	DL, 0x00		; 驱动器号A
    42 0000005C B500                    	MOV	CH, 0			; 柱面，从0开始
    43 0000005E B600                    	MOV	DH, 0			; 磁头，从0开始
    44 00000060 B102                    	MOV	CL, 2			; 扇区号，1开始
    45 00000062 B82008                  	MOV	AX, 0x0820		; 缓冲区从0x0820:0000开始
    46 00000065 8EC0                    	MOV	ES, AX
    47 00000067 BB0000                  	MOV	BX, 0			; (ES:BX)缓冲区
    48                                  
    49                                  readloop:	
    50 0000006A BE0000                  	mov	SI, 0
    51                                  retry:	
    52 0000006D B402                    	MOV	AH, 0x02		; 读盘
    53 0000006F B001                    	MOV	AL, 1			; 扇区数
    54 00000071 CD13                    	INT	0x13			; 调用磁盘BIOS
    55 00000073 730E                    	JNC	next			; 成功，读取下一个扇区
    56 00000075 83C601                  	ADD	SI, 1
    57 00000078 83FE05                  	CMP	SI, 5
    58 0000007B 7333                    	JAE	error			; 尝试5次
    59 0000007D B400                    	MOV	AH, 0x00
    60 0000007F CD13                    	INT	0x13			; 重置驱动器
    61 00000081 EBEA                    	JMP	retry
    62                                  next:
    63 00000083 8CC0                    	MOV	AX, ES
    64 00000085 83C020                  	ADD	AX, 0x0020
    65 00000088 8EC0                    	MOV	ES, AX
    66 0000008A 80C101                  	ADD	CL, 1
    67 0000008D 80F912                  	CMP	CL, 18
    68 00000090 76D8                    	JBE	readloop
    69 00000092 B101                    	MOV	CL, 1			; 下一个磁道，扇区从1开始
    70 00000094 80C601                  	ADD	DH, 1
    71 00000097 80FE02                  	CMP	DH, 2
    72 0000009A 72CE                    	JB	readloop		; 下一个柱面，磁头从0开始
    73 0000009C B600                    	MOV	DH, 0
    74 0000009E 80C501                  	ADD	CH, 1
    75 000000A1 80FD0A                  	CMP	CH, CYLS
    76 000000A4 72C4                    	JB	readloop
    77 000000A6 882EF00F                	MOV	[0x0ff0], CH		; 
    78 000000AA E9(00C4)                	JMP	0xc400
    79                                  
    80                                  fin:
    81 000000AD F4                      	HLT				; 让CPU停止，等待指令
    82 000000AE EBFD                    	JMP	fin			; 无限循环
    83                                  
    84                                  error:
    85 000000B0 BE[C500]                	MOV	SI, msg
    86                                  putloop:
    87 000000B3 8A04                    	MOV	AL, [SI]		; [DS:SI]汇编中可以省略，使用默认
    88 000000B5 83C601                  	ADD	SI, 1			; 给SI加1
    89 000000B8 3C00                    	CMP	AL, 0
    90 000000BA 74F1                    	JE	fin
    91 000000BC B40E                    	MOV	AH, 0x0e		; 显示一个文字
    92 000000BE BB0F00                  	MOV	BX, 15			; 指定字符颜色
    93 000000C1 CD10                    	INT	0x10			; 调用显卡BIOS
    94 000000C3 EBEE                    	JMP	putloop
    95                                  
    96                                  msg:
    97 000000C5 0A0A                    	DB	0x0a, 0x0a		; 换行2次
    98 000000C7 6C6F6164206572726F-     	DB	"load error!"
    99 000000D0 7221               
   100 000000D2 0A                      	DB	0x0a			; 换行
   101 000000D3 00                      	DB	0
   102                                  
   103 000000D4 00<rept>                	times 	0x1fe-($-$$) DB 0
   104 000001FE 55AA                    	DB	0x55, 0xaa
